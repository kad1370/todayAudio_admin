<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>성공자 오디오</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="./manifest.json">
</head>
<body>
<h1>오오</h1>
<div>
    <input name="title" placeholder="제목"></input>
    <input name="desc" placeholder="내용"></input>
    <input name="file" placeholder="파일"></input>
    <buttion id="regist" onclick="regist()">등록하기</buttion>
</div>
<div>
    <input name="search" placeholder="검색어를 입력하세요"></input>
    <buttion id="search" onclick="search()">검색</buttion>
</div>
<div id="list"></div>
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
    }
    const ADMIN_TOKEN = 'ba10cc7b9ba5b27317d546824a01203d89c0ea3e0972fab50cb786ab5a702dff';

    (async () => {
        /*
        const response = await fetch('https://todayaudio.writer1370.workers.dev/api/list', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${ADMIN_TOKEN}`
          }
        });

        const data = await response.json();
        let audioList = data.audioList;

        const list = document.getElementById('list');

        for(let data of audioList) {
          let audioData = JSON.parse(data);
          const div = document.createElement('div');
          div.className = 'audio-card';
          div.innerHTML = `
            <span>${audioData.title}</span>
            <span>${audioData.description}</span>
            <div>
                <audio controls playsinline preload="metadata" src="${audioData.url}"></audio>
                <a href="${audioData.url}" download>⬇️ 다운로드</a>
            </div>
          `;
          list.appendChild(div);

          const audioElement = div.querySelector('audio');
          const audioCtx = new AudioContext();
          audioElement.addEventListener('play', async () => {
            // 1. 상태가 1(Metadata만 있음)이거나 에러 상태라면 강제 리셋
            if (audioElement.readyState === 1 || audioElement.readyState === 0) {
                const currentSrc = audioElement.src;
                audioElement.src = ''; // 소스를 비웠다가
                audioElement.src = currentSrc; // 다시 넣어서 세션을 완전히 새로 고침
                audioElement.load();

                await new Promise(resolve => setTimeout(resolve, 200));
            }
          });
        }
    })();


    function regist(){
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        const yyyymmddhhmmss = `${year}${month}${day}${hours}${minutes}${seconds}`;

        let data = {
            id : yyyymmddhhmmss,
            title : document.getElementsByName("title")[0].value,
            description : document.getElementsByName("desc")[0].value
        }

        fetch('https://todayaudio.writer1370.workers.dev/api/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${ADMIN_TOKEN}`
          },
          body: JSON.stringify(data)
        });
    }
</script>
<script src="app.js"></script>
</body>
</html>
