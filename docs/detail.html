<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오오 - 상세 페이지</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="./manifest.json">
</head>
<body>
<div class="header-wrapper">
    <button class="back-btn" onclick="history.back()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>

    </button>
    <h1>⭐오늘의 오디오⭐</h1>
</div>

<div class="audio-card">
    <span class="title" name="title">로드 중...</span>
    <span class="desc" name="desc">잠시만 기다려 주세요.</span>
</div>

<div class="listContainer">
    <div id="list">
        <div class="audio-player-container">
            <div class="audio-controls">
                <audio controls playsinline preload="metadata"></audio>
            </div>
            <button class="add-btn" id="addBtn" onclick="addTime()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>
    </div>
    <!-- <button class="download-btn" id="downloadBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span>다운로드</span>
    </button>     -->
</div>
<div id="bookmarkList" class="bookmark-container">
    <p style="font-size:14px; font-weight:bold; color:#000;">✅ 북마크 ･ω･</p>
</div>


<script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const id = urlParams.get('id');
        const audio = document.querySelector('audio');

        if (id) {
            createAudioPlayer(id);
        } else {
            alert("잘못된 접근입니다.");
            history.back();
        }

        async function createAudioPlayer(id) {
            try {
                // 1. 데이터 및 캐시 로드
                const cache = await caches.open('audio-cache');
                const cachedResponse = await cache.match(id);

                if (!cachedResponse) {
                    alert("오디오 파일을 찾을 수 없습니다.");
                    return;
                }

                const audioBlob = await cachedResponse.blob();
                const data = JSON.parse(window.localStorage.getItem(id)) || { title: "제목 없음", desc: "설명 없음" };

                // 2. 화면 데이터 매핑
                document.querySelector('[name="title"]').textContent = data.title;
                document.querySelector('[name="desc"]').textContent = data.desc;

                // 3. 오디오 URL 생성 및 설정
                const audioUrl = URL.createObjectURL(audioBlob);

                const addBtn = document.getElementById('addBtn');
                audio.src = audioUrl;

                /*
                const downloadBtn = document.getElementById('downloadBtn');

                // 5. 다운로드 버튼 클릭 이벤트
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = audioUrl;
                    a.download = `${data.title || id}.mp3`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };

                // 6. 메모리 관리: 페이지를 떠날 때 ObjectURL 해제
                window.addEventListener('unload', () => {
                    URL.revokeObjectURL(audioUrl);
                });
                */
            } catch (error) {
                console.error("오디오 플레이어 생성 실패:", error);
                alert("오디오를 불러오는 중 오류가 발생했습니다.");
            }
        }

        function addTime(){
            let currentTime = formatTime(document.querySelector('audio').currentTime);
            // 현재 재생 시간 가져오기 (초 단위)
            const target = document.getElementById('bookmarkList');

            // 2. DOM 요소 생성 (innerHTML 대신 createElement 권장)
            const row = document.createElement('div');
            row.className = 'bookmark-row';

            // 시간 버튼 (클릭 시 이동)
            const btn = document.createElement('button');
            btn.className = 'time-tag';
            btn.textContent = currentTime;
            btn.onclick = () => {
                audio.currentTime = timeToSeconds(currentTime);
                audio.play();
            };

            // 메모 입력창
            const input = document.createElement('input');
            input.className = 'memo-input';
            input.placeholder = '여기에 메모를 입력하세요...';

            row.appendChild(btn);
            row.appendChild(input);
            target.appendChild(row);
        }

        function formatTime(seconds){
            const hrs = Math.floor(seconds / 3600);      // 시간 계산
            const min = Math.floor((seconds % 3600) / 60); // 분 계산
            const sec = Math.floor(seconds % 60);        // 초 계산

            // 한 자릿수일 때 앞에 0을 채워주는 함수
            const pad = (num) => String(num).padStart(2, '0');

            if (hrs > 0) {
                // 1시간 이상일 때 (예: 01:05:30)
                return `${pad(hrs)}:${pad(min)}:${pad(sec)}`;
            } else {
                // 1시간 미만일 때 (예: 05:30)
                return `${pad(min)}:${pad(sec)}`;
            }
        }

        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) { // 시:분:초
                return (parts[0] * 3600) + (parts[1] * 60) + parts[2];
            } else { // 분:초
                return (parts[0] * 60) + parts[1];
            }
        };
    </script>
</body>
</html>